import os
from models.base_model import BaseModel
from models.db_config import DB_PATH

class {{ class_name }}(BaseModel):
    table_name = "{{ table_name }}"
    fields = {{ model_fields }}
    field_definitions = {{ formatted_defs }}

    def __init__(self, **kwargs):
        for field in self.fields:
            setattr(self, field, kwargs.get(field))
        # Joined fields
        self.created_by_name = kwargs.get("created_by_name")
        self.updated_by_name = kwargs.get("updated_by_name")

    @classmethod
    def index(cls, filters=None, search=None, pagination=False, items_per_page=10, page=1, **kwargs):
        base_fields = [f"t.{f}" for f in cls.fields]
        join_query = f"""
            SELECT {', '.join(base_fields)}, 
                   COALESCE(u1.name, u1.username) as created_by_name,
                   COALESCE(u2.name, u2.username) as updated_by_name
            FROM {cls.table_name} t
            LEFT JOIN users u1 ON t.created_by = u1.id
            LEFT JOIN users u2 ON t.updated_by = u2.id
        """
        custom_fields = cls.fields + ["created_by_name", "updated_by_name"]

        return super().index_sqlite(
            DB_PATH,
            cls.table_name,
            cls.fields,
            filters=filters,
            search=search,
            pagination=pagination,
            items_per_page=items_per_page,
            page=page,
            sort_by=kwargs.get('sort_by', '{{ sort_field }}'),
            sort_order=kwargs.get('sort_order', '{{ sort_direction }}'),
            custom_query=join_query,
            custom_fields=custom_fields,
            table_alias="t"
        )

    @classmethod
    def edit(cls, id):
        base_fields = [f"t.{f}" for f in cls.fields]
        join_query = f"""
            SELECT {', '.join(base_fields)}, 
                   COALESCE(u1.name, u1.username) as created_by_name,
                   COALESCE(u2.name, u2.username) as updated_by_name
            FROM {cls.table_name} t
            LEFT JOIN users u1 ON t.created_by = u1.id
            LEFT JOIN users u2 ON t.updated_by = u2.id
        """
        custom_fields = cls.fields + ["created_by_name", "updated_by_name"]

        return super().edit_sqlite(
            DB_PATH, 
            cls.table_name, 
            cls.fields, 
            row_id=id,
            custom_query=join_query,
            custom_fields=custom_fields,
            table_alias="t"
        )

    @classmethod
    def store(cls, **kwargs):
        return super().store_sqlite(DB_PATH, cls.table_name, **kwargs)

    @classmethod
    def update(cls, id, **kwargs):
        return super().update_sqlite(DB_PATH, cls.table_name, id, **kwargs)

    @classmethod
    def destroy(cls, id):
        return super().destroy_sqlite(DB_PATH, cls.table_name, id)

    @classmethod
    def get_dynamic_field_definitions(cls):
        return cls.field_definitions
